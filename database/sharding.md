# 샤딩(Sharding)

## 파티셔닝(Partitioning)

서비스 규모가 커지면서 DB의 용량 한계와 성능저하가 발생할 때 성능, 가용성, 정비용이성 등의 목적으로 테이블을 Partition이라는 작은 단위로 나누어 관리하는 기법

### 장점

- 쿼리의 성능을 향상 시킴(부분적으로)
- 가용성: 물리적으로 데이터를 분산시켜 전체 데이터 훼손 가능성이 줄어듬 (장점이라고 하기에는 애매함)
- 정비 용이성 파티션 단위 데이터 백업 가능


### 단점

- 테이블간 조인 비용 증가
- 테이블과 인덱스를 별도로 파티셔닝할 수 없음


## 파티셔닝 종류

### Vertical Partitioning

도메인에 따라 DB/테이블 분리

### Horizontal Partitioning (= Sharding)

같은 테이블 스키마를 가진 데이터를 여러 DB/Table에 분산


## 샤딩(Sharding) 종류

### Key(Hash) Based Sharding

- key를 Hash 함수에 넣어 나오는 값을 기준으로 분할
- Hash 결과가 균등하도록 Hash 함수를 정해야 함
  - ex) id % 4 -> 0 ~ 3 의 결과값으로 DB 분배
- 장점: 데이터가 균등하게 분산됨
- 단점: 추가 증축을 위해 고비용의 데이터 재분배 작업을 해야함

### Range Sharding

- 특정 feature의 범위 별로 분할
- 범위에 따라 데이터를 나누기에 데이터 분할 방법이 예측 할 수 있는 것이어야 함
  - ex) 인덱스, 생성 날짜, 우편 번호 등
- 장점: 추가 증축에 데이터 재분배 작업이 필요 없음
- 단점: 데이터가 골고루 분배되지 않기 때문에 노드간 트래픽 불균등 발생


---
## 샤딩을 적용하기 전에..

개발, 운영 복잡도가 높아지기 때문에 샤딩을 피하거나 지연시키는 것이 우선 (복잡한 쿼리에 큰 제약이 생기기 때문)
  - 더 좋은 HW 스펙으로 교체
  - 트래픽이 문제인 경우 캐시 사용하거나 [리플리케이션(Replication)](https://iiaii.tistory.com/7)
  - 테이블 일부 컬럼을 자주사용하면 Vertical Partition 고려 (도메인에 따라 테이블/DB 분리)

## 샤딩을 적용해야 한다면

- 샤딩 키를 이용한 단순한 쿼리만 사용하도록 모델링
- 샤딩 테이블과 관련없는 쿼리는 일반 Datasource를 사용하여 처리
  - 미지원 쿼리 존재로 복잡한 쿼리 실행 보장 X
- DB 설계 단계에서 샤딩 가능성이 높은 테이블을 예측하여 Sharding Sphere 도입
  - Key Generator 활용, Configuration 추가만으로 샤딩이 가능하도록 설계


